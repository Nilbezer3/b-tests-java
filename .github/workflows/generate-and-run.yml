name: Generate & Run Java Tests

on:
  repository_dispatch:
    types: [new_endpoints]
  workflow_dispatch: {}

jobs:
  gen_and_test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout this repo (b-tests-java)
      - name: Checkout B (this repo)
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Python for generator
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3Ô∏è‚É£ Install Python dependencies
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install google-generativeai

      # 4Ô∏è‚É£ Save payload from A (if repo_dispatch)
      - name: Save payload (repo_dispatch)
        if: ${{ github.event_name == 'repository_dispatch' }}
        run: echo '${{ toJson(github.event.client_payload) }}' > payload.json

      # 5Ô∏è‚É£ Fallback payload for manual runs
      - name: Fallback payload (manual)
        if: ${{ github.event_name != 'repository_dispatch' }}
        run: echo '{"endpoints":[]}' > payload.json

      # 6Ô∏è‚É£ Generate Java tests with Gemini
      - name: Generate Java tests with script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scripts/generate_tests_with_gemini.py

      # 7Ô∏è‚É£ Show generated Java test in logs
      - name: Show generated Java test
        run: sed -n '1,200p' src/test/java/com/generated/ApiSmokeIT.java || true

      # 8Ô∏è‚É£ Commit and push generated tests back to GitHub ‚úÖ
      - name: Commit generated tests
        if: ${{ github.event_name == 'repository_dispatch' }}
        env:
          GH_PAT: ${{ secrets.B_REPO_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
  
          git add src/test/java/com/generated/ApiSmokeIT.java
  
          # Deƒüi≈üiklik yoksa commit etme
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
  
          git commit -m "Auto-update generated API tests from workflow"
  
          # *** √ñNEMLƒ∞ KISIM: PAT'i URL'de kullanƒ±yoruz ***
          git push https://x-access-token:${GH_PAT}@github.com/Nilbezer3/b-tests-java.git HEAD:main

      # 9Ô∏è‚É£ Checkout A repo (app-repo)
      - name: Checkout A (app-repo)
        uses: actions/checkout@v4
        with:
          repository: Nilbezer3/app-repo
          token: ${{ secrets.A_REPO_PAT }}
          path: app-src
          fetch-depth: 1

      # üîü Setup Java 17
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      # 11Ô∏è‚É£ Build A (Spring Boot)
      - name: Build A (Spring Boot)
        working-directory: app-src
        run: mvn -q -DskipTests package

      # 12Ô∏è‚É£ Start A on port 8080 and wait until UP
      - name: Start A on :8080
        working-directory: app-src
        run: |
          nohup java -jar target/*.jar > ../app.log 2>&1 &
          for i in {1..40}; do
            curl -sf http://localhost:8080/health && echo "UP" && break || sleep 1
          done
          tail -n 80 ../app.log || true

      # 13Ô∏è‚É£ Run generated Java tests in B
      - name: Run Java tests in B
        env:
          BASE_URL: http://localhost:8080
        run: mvn -Dtest=ApiSmokeIT test

      # 14Ô∏è‚É£ Upload logs and test results as artifacts
      - name: Upload artifacts (tests & logs)
        uses: actions/upload-artifact@v4
        with:
          name: java-tests-and-logs
          path: |
            src/test/java/com/generated/ApiSmokeIT.java
            target/surefire-reports/
            app.log
          if-no-files-found: ignore
