name: Generate & Run Java Tests

on:
  repository_dispatch:
    types: [new_endpoints]

jobs:
  gen_and_test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout this repo (b-tests-java)
      - name: Checkout B (this repo)
        uses: actions/checkout@v4

      # 2. Setup Python (for Gemini test generation)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install dependencies
      - name: Install Python deps
        run: |
          pip install --upgrade pip
          pip install google-generativeai

      # 4. Save incoming payload (from A)
      - name: Save payload (repo_dispatch)
        if: ${{ github.event_name == 'repository_dispatch' }}
        run: echo '${{ toJson(github.event.client_payload) }}' > payload.json

      # 5. Generate Java tests using Gemini
      - name: Generate Java tests with script
        run: python scripts/generate_tests_with_gemini.py

      # 6. Show generated test in logs
      - name: Show generated Java test
        run: cat src/test/java/com/generated/ApiSmokeIT.java

      # 7. Commit and push generated tests back to repo âœ…
      - name: Commit generated tests
        env:
          GITHUB_TOKEN: ${{ secrets.B_REPO_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add src/test/java/com/generated/ApiSmokeIT.java
          git commit -m "Auto-update generated API tests from workflow" || echo "No changes to commit"
          git push https://Nilbezer3:${GITHUB_TOKEN}@github.com/Nilbezer3/b-tests-java.git main

      # 8. Checkout A repo to build & run against it
      - name: Checkout A (app-repo)
        uses: actions/checkout@v4
        with:
          repository: Nilbezer3/app-repo
          token: ${{ secrets.B_REPO_PAT }}

      # 9. Setup JDK for testing
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 10. Run Maven tests (connects to A if running)
      - name: Build A (Spring Boot)
        run: mvn -q -DskipTests package

      - name: Run unit tests
        run: mvn -q test
