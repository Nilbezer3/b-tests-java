name: Generate & Run Java Tests

on:
  repository_dispatch:
    types: [new_endpoints]
  workflow_dispatch: {}

jobs:
  gen_and_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout B (this repo)
        uses: actions/checkout@v4

      - name: Setup Python (generator için)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install google-generativeai

      - name: Save payload (repo_dispatch)
        if: ${{ github.event_name == 'repository_dispatch' }}
        run: echo '${{ toJson(github.event.client_payload) }}' > payload.json

      - name: Fallback payload (manual)
        if: ${{ github.event_name != 'repository_dispatch' }}
        run: echo '{"endpoints":[]}' > payload.json

      - name: Generate Java tests with script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scripts/generate_tests_with_gemini.py

      - name: Show generated Java test
        run: sed -n '1,200p' src/test/java/com/generated/ApiSmokeIT.java || true

      # A repo'yu çekip ayağa kaldır
      - name: Checkout A (app-repo)
        uses: actions/checkout@v4
        with:
          repository: Nilbezer3/app-repo
          token: ${{ secrets.A_REPO_PAT }}
          path: app-src
          fetch-depth: 1

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Build A (Spring Boot)
        working-directory: app-src
        run: mvn -q -DskipTests package

      - name: Start A on :8080
        working-directory: app-src
        run: |
          nohup java -jar target/*.jar > ../app.log 2>&1 &
          for i in {1..40}; do
            curl -sf http://localhost:8080/health && echo "UP" && break || sleep 1
          done
          tail -n 80 ../app.log || true

      - name: Run Java tests in B
        env:
          BASE_URL: http://localhost:8080
        run: mvn -Dtest=ApiSmokeIT test

      - name: Upload artifacts (tests & logs)
        uses: actions/upload-artifact@v4
        with:
          name: java-tests-and-logs
          path: |
            src/test/java/com/generated/ApiSmokeIT.java
            target/surefire-reports/
            app.log
          if-no-files-found: ignore
