name: Generate & Run AI Tests

on:
  # A repo'su bu event ile B'yi tetikleyecek
  repository_dispatch:
    types: [new_endpoints]

  # Manuel deneme için
  workflow_dispatch: {}

jobs:
  gen_and_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout B (this repo)
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai pytest requests

      # repository_dispatch geldiyse payload'ı kaydet
      - name: Save payload from repository_dispatch (if any)
        if: ${{ github.event_name == 'repository_dispatch' }}
        run: echo '${{ toJson(github.event.client_payload) }}' > payload.json

      # Manuel çalıştırmada fallback payload (boş -> /health)
      - name: Create fallback payload (manual runs)
        if: ${{ github.event_name != 'repository_dispatch' }}
        run: |
          echo '{"endpoints":[]}' > payload.json
          cat payload.json

      - name: Generate tests with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python scripts/generate_tests_with_gemini.py
          echo "===== generated test ====="
          sed -n '1,200p' tests/generated/test_generated_endpoints.py || true

      # A repo'sunu PAT ile klonla
      - name: Checkout A repo (app-repo)
        uses: actions/checkout@v4
        with:
          repository: Nilbezer3/app-repo
          token: ${{ secrets.A_REPO_PAT }}
          path: app-src
          fetch-depth: 1

      # JDK & Maven
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Build A (Spring Boot)
        working-directory: app-src
        run: mvn -q -DskipTests package

      - name: Start A (Spring Boot) on :8080
        working-directory: app-src
        run: |
          nohup java -jar target/*.jar > ../app.log 2>&1 &
          for i in {1..40}; do
            curl -sf http://localhost:8080/health && echo "UP" && break || sleep 1
          done
          echo "---- recent app log ----"
          tail -n 80 ../app.log || true

      - name: Run pytest against A
        env:
          BASE_URL: http://localhost:8080
        run: pytest -q || true

      - name: Upload artifacts (tests & logs)
        uses: actions/upload-artifact@v4
        with:
          name: ai-generated-tests-and-logs
          path: |
            tests/generated/
            app.log
            .pytest_cache/**/*
          if-no-files-found: ignore
